03.7-Flujo óptico y codecs de video
https://www.youtube.com/watch?v=nlDWJ2ZJ4Sk
 en este vídeo vamos a hablar sobre codex un concepto importante que hay que entender es el del flujo óptimo aquí tenemos dos frentes consecutivos de un vídeo 1 y 2 el flujo y ccoo que lo que consiste en para cada pixel uno toma una vecindad y uno mira la vecindad en el fin siguiente e intenta ver para dónde se movió este rectángulo usualmente el tren consecutivos son pequeños movimientos pequeños desfases y hay que descubrir ese pequeño desfase si es para cada una de las ventanas de la imagen esto un algoritmo tiempo han empezado porque para muchas ventanas tienes que ir viendo hacia dónde se movió y ahí ese movimiento lo puede hacer una ventana pequeña o una ventana grande y también se hace muy fiscal para cuando son movimientos de objetos grandes es un algoritmo que es en pesado y que su salida es esta como mapa de vectores que se llaman los mentores de molina héctor para probarlo en vivo que les deje un código de ejemplo que está escrito en las bahamas que llama a una función de flujo óptico que recibe dos frames el clima anterior y el frame actual en gris y el interno como salida una imagen de dos canales que son las dos componentes de cada uno de los vectores y tiene una serie de parámetros el más importante es el una talega estará muy pequeño y aún no produce resultados eficientes y funcionando [Música] vamos a jugar el ejemplo sobre la webcam está moviéndose cada movimiento cuando toman dos frames consecutivos van calculando que se hacen es por ventanas y descubre cuál fue el movimiento que ocurrió en cada uno de los países y se está dibujando sobre el mismo frente aquí está arriba se está dibujando en el tamaño de la ventana que se está usando y suma es la suma de las magnitudes de los vectores esta se llama un deseamos un flujo de ansó porque se está calculando para todos los pixeles y si si reducimos el tamaño de la ventana aumentan a tres por ejemplo se vuelve bastante ruidoso y detecta muchos movimientos en cualquier momento pequeño genera una cantidad de vectores y que hoy somos la ventana más grande 21 90 x 21 ya se hace más estable ahora el ejemplo pero con vida ah y se puede ver como el calculando los vectores de movimiento y va haciendo con un seguimiento de los movimientos dentro del frente hay que diferenciar este algoritmo del algoritmo de tracking espero algoritmo de intenso y un algoritmo de tracking consiste en encontrar algunos puntos algunas esquinas y hacer el seguimiento solamente esa esquina era un algoritmo que es mucho más liviano espero que vean aquí cuando está haciendo un planning de la cámara va detectando todos los movimientos un movimiento en todo el mundo él aquí hay que decir que no se está mostrando todos los vectores porque sino en realidad no se ve nada en el frente sino que está lo que está dos por dos lo podemos ver en el que está dibujando los lectores está saltando con usted de 3 está dibujando cada uno cada tres electores este algoritmo y puede ir probando con s [Música] aquí pueden ver la documentación [Música] la documentación está allí en este link y es muy muy buena el libro donde se ve la explicación también de este al vuelo por si quieres saber más detalles entonces el flujo digo nos permite encontrar sectores mi movimiento [Música] y eso nos permite calcular en calcular entonces diferencial de imágenes no va a definir la imagen residual en principio vamos a definir la imagen residual como la diferencia entre dos frames consecutivos si el futuro del arresto our frame actual nos va a quedar la diferencia en periodos si es que hay hay mucho movimiento la imagen residual va a ser va a tener mucha información si es que principalmente estático esto se va a ser mayormente cero [Música] y la idea es que es mucho mejor en un frame en vez de guardar cada una de las imágenes formación paradas vamos a guardar la primera imagen y luego vamos a ir guardando los diferenciales es decir una serie de imágenes residuales aquí hay un ejemplo de una imagen principal tenemos 2 fran consecutivos y hasta un visual este ejemplo está sacado de este libro que explica el códec h 264 también interesante aquí tenemos dos frentes esto es una imagen gris proyecto es cero y en la zona blanca es positivo y la zona negra es negativa y como aquí la primera nota es que cuando hay un movimiento enfren consecutivos no son píxeles y lados siempre son píxeles en grupo entonces lo que es muy bueno es tratar de representar el movimiento de grupos de píxeles y eso lo vamos a hacer por los llamados macro bloques vamos a decir un tamaño de ventana y vamos a determinar que para una ventana la ubicación de esa ventana en el extremo anterior y vamos a determinar el vector de movimiento conectamos el flujo que ya se le íbamos a llevar los vectores muy bien los muchos efectos y para quien nos va a servir eso por qué vamos a tratar de estimar mejor cómo se hace esto desde determinar cuál es el mucho un vector por ventana es que uno toma alguna vez toma una ventana en un frame toma la misma ventana tomar una posición en el frame el frame 1 vamos al frente y aquí hay un pequeño movimiento lo que se hace es que esta ventana se va desplazando iba calculando que es la diferencia entre visiones lo que veíamos al lado tenemos distintas métricas que podemos usar para calcular la diferencia de las ventanas y es esencialmente d'esquadra tico y esto está como está su clic en todo esto que es como a distancia en absoluto [Música] y esto es una constante y no nuestro y bueno y nos quedamos con alguna estas métricas de una este libra están totalmente éstas tienen que está haciendo es tratar de tratar de encontrar a donde es el mejor desplazamiento de él para encontrar dónde se ubica es donde se ubica esta es tu ventana en el siguiente y aquí de hecho esta gráfica para dos metas distintas la posición y dice que aquí el mínimo ocurre en un desplazamiento de dos y ser importante entre el freno uner siendo esta ventana que en su mejor ubicación es con un desplazamiento de dos en en el eje x y cero en el eje y ahí tenemos el vector de ir muy bien podemos entonces calcular una una secuencia de vectores de movimientos para todo el frame cué siempre me dice para más macro bloqueas ni 4x4 y la idea ahora es que el frame 2 master el tren 1 el facebook no les vamos a ajustar por los vectores de movimiento y luego de eso vamos a calcular la imagen presión porque hacemos eso que ahora con los vectores de movimiento que si calculamos venderte movimiento también 4x4 para la ventaja de 44 vamos a tener muchos vectores de movimiento y la imagen residual va a ser cada vez más cercana a cero si calcularemos vectores de movimientos con ventanas más grandes de 1616 los bloques son más grandes por tanto vamos vamos a cometer más errores de habilitado consideran dos bloques movimientos de bloques de cuadrados grandes entonces el ajuste no va a ser tan exacto e importante la imagen residual va a aumentar un poco pero por otra parte vamos a tener menos este movimiento que estamos calculando por las ventanas más grandes de aquí son de 16 16 y en que iban a ser de 4 x 4 [Música] entonces aquí se ve un traidor un compromiso donde si tenemos muchos vectores de movimiento vamos a tener una imagen residual más el financiero todo si calculamos menos vectores de movimiento vamos de una imagen y aquí hay que tener un buen ajuste de tamaño de ventana para que sea un buen bar así los dos tienen en un tamaño adecuado y no sé y no tiene uno demasiado grande porque creemos que quiere que la imagen del ciudadano general con muchos ceros porque eso es muy comprensible de hecho la idea es que la compresión de la secuencia de frames se va se va a ser calculando los factores de movimiento entre los frentes consecutivos cercanos luego calcular las imágenes residuales y esa imagen es residual en las vamos a poder guardar sí que son muy cercanas a cero con una compresión como cuando mismo la complicado jpg y en a través de la plataforma es que está consciente y eso va a generar una imagen residual muy comprensible con muchos ceros que es que se comprime por una codificación jabón o alguna otra compresión sin pérdida este varón sin muchos otra mano finalmente igual con que se comprimen imágenes pero se comprimen imagen dependiente sino que se comprimen son las imágenes residuales y los ventanas de movimiento ahora en un vídeo última secuencia larga de frames si hiciéramos unos diferenciales durante toda la película de una hora eso sería un problema porque no si queremos saltar a la mitad de la película tendríamos que decodificar toda nada todos los 30 minutos para poder saltar a la mitad para puesto estará mi nombre entonces para hacer eso es que se definen tres tipos de frames los frames que iban a hacer frente independientes y quien estará acá son esencialmente son cuatro ejes de fleming es una imagen independiente y que nos permite usarlo como base como ancla para saltar desde el inicio podemos saltar aquí aquí y esto es todo el archivo el formato un archivo tiene que saber dónde están estos frentes y porque son los que nos permite saltar entre medios de un vídeo luego vamos a tener los frentes tipo p los frames tipo p que son éstos acá es lo que hemos estado hablando ahora que son diferenciales como son vectores con respecto al frame anterior predictivos importante este frente depende del 30 anterior y este dependiente del anterior y hasta que depende un y el y no depende de ninguno anterior y aquí estoy calculando los vectores del movimiento las imágenes residuales llevamos a un tercer vivo de friends que se llaman los frames tipo b que según los bidireccionales un frame bidireccional que depende del pasado y también depende del futuro eso es clave sino como un frente y por el mismo gesto va a usar vectores de movimiento con respecto al frente anterior al frente anterior de anterior anterior o posterior futuro como tenemos dos frentes y podemos tenemos muchas más opciones para escoger un buen vector de movimiento y usualmente el frente que tiene imágenes residuales muy cercanas a hacer y sólo más comprensibles porque supone a él la introducción de los frames bidireccionales de la gracia se puede ver aquí no porque no depender del futuro por línea [Música] de este libro aunque en este en esta secuencia frames va apareciendo un avión si lo hiciéramos solamente con friends tipo b que son los aperitivo hacia delante por muchos vectores y como estaba pareciendo un avión que una figura que no tiene considera no hay como referencia a ella necesariamente todo el cuerpo del avión va a ir apareciendo en las imágenes residuales un vector que permita haber predecido este es esta nueva nueva forma y cuando va sigue avanzando en el área finalmente todo el avión va a ir apareciendo de a poco en todas las imágenes las ciudades la gracia de un frente tipo b es que si uno codifica el futuro primero uno que codifica este frente en este fe va a pasar lo mismo va a estar en el avión completo en su cuerpo completo prueba estar completa enseña y luego los diferenciales de cuando va apareciendo el avión esto solamente van a ir referenciando a zonas ventanas del frankfurt donde ya está donde los que ya apareció por tanto todos los frentes donde van donde va apareciendo un objeto en realidad solamente referencia en con un botón vector al al ain al frame futuro donde llega hasta logias y eso hace que el objetivo que sean muy comprensibles el aquí y aquí dice como un frame tipo de dependiente un vector de movilización hacia el futuro o ha sido poco en el pasado bien entonces en una codificación de un vídeo hay que separar estos tres tipos de fresa los jpg independientes no dependen de otro frame los frames tipo p son los colectivos que dependen de un frame previo en el pasado y los tipos que son los de mayor compresión y que independiente el pasado y en el futuro ya eso depende del futuro y hace que sea le da dificultad a la decodificación porque para web decodificar los necesitamos conocer cómo podemos mostrar un vídeo porque vamos a posicionar un frame baynes y tamos describir al futuro para hacer eso es que es un frame constaron un vídeo y aquí como aquí está el ejemplo está 1234 aquí está la secuencia de friends y él sí fue tipo y veo perder el tiempo estamos acá en un tiempo bien y aquí aparece el siguiente [Música] y el fin del 20 y del futuro del día anterior y en el p esto se va a ir modificando y se deben de guardar en otro orden como que el orden tiene que ser así hay que guardar primero haciendo haciendo este movimiento el reinicio mantiene ahí luego tenemos que guardar el frame de futuro es el siguiente porque necesitamos haber decodificado este frente para poder decodificar el ministro en 2003 eso eso es eso es algo que es importante notar que entonces como tenemos frente y direccionales que dependen del futuro esto se tiene que guardar el frame los frames direccionales tienen que guardados después de el frente de los frames de los cuales depende si no me como decodificar por tanto esta fuerza que es el ordenamiento y fuerza aquí el decodificador requiere de un bazar tiene que ir destinando más adelante de lo necesario porque para poder mostrar el sector tiene que haber decodificado el 1 y el 4 final y ahí podemos también 2003 después muestra el 4 que ya tiene y luego ver tener el 7 para después poder decodificar y mostrar el 5 y ese reordenamiento entonces hay que tenerlo en consideración en los planes de un play un player de un vídeo no va de cualificando y mostrando la avenida que va extrayendo frames de vídeo comprimido sino que requiere un buffer para ir modificando y acumulando para poder decodificar los directores [Música] hay herramientas para los vídeos y en realidad lo que lo que quiero mostrar es que tienes que conocer la herramienta de extracción es una herramienta de edición de vídeos por línea comandos o menotti limpia poderosa y además tiene librería y se puede lanzar con ellas para uno pueden hacer juegos de codificar y decodificar bien vidas hay otras ayudas que tenía importantes la esquina 104 y x5 que en realidad no no les gusta no las use directamente serán cientos hombros codex el codex de vídeos y que están integrados que el espacio pp pero uno nos llaman para codificar el vídeo usando estos códecs también es común [Música] el plane plc tiene uno después a poder producir vídeos y tiene un montón de códecs y youtube de él con esta herramienta pueden descargar me gustaría darle un ejemplo sobre ese examen en algunos comandos útiles niveles suben útiles de aprender a usarlo aquí hay un poco de cómo codificar vídeos como escalar vídeo concatenar en un vídeo tras otro las líneas de comandos montería que mostraste las por ejemplo más flojos y el vídeo y luego olvida salir si decimos flujos lo que va a hacer es que va a hacer un rincón está tomando el vídeo esto está y está generando un vídeo de salida haciendo recodificar pero solamente es un vídeo de 50 segundos y ahí se ve la velocidad que alcanzaba a una velocidad de 16 importante 150 segundos se demorar un poco menos en codificar y esto va a girar el archivo el flujo 2.94 que por defecto si uno no pone nada esto está usando en la línea x hace cuatro meses porque cuando ponía 24 en convencer de que asume la librería x 12 4 y el códec h 264 aquí estaba hablando con él cuando 20 p eso ya lo vimos el espacio y bien hace de cr con cuando 2040 lo estándar para los dos vídeos y progresivo aquí dice tentó a la estadística una es que terminas en el brincolín que generó 6 frames tipo y 460 frames tipo p y 1.025 frames tipo b de los bidireccionales y el diestro también este dato interesante de saber que la cantidad de de frames consecutivos ve él porque tiene un indicador para saber cuándo bueno generar un frente y beauvais y cuando mejor no hacer y aquí dice que estos cuentos y no uno dos tres o cuatro films consecutivos y aquí uno ve que en general uso cuatro friends be consecutivas de los parámetros no puede aumentarlo aquí no ve que la gran mayoría 4 entonces no podría tratar de poner que fueran secuencias más largas y se puede reducir más en tamaños nos hemos mostrado el tamaño para hacer un rincón se reduce el tamaño de nuestro tamaño por dos razones una es con información de extracción codding y rincón consecutivamente en la imagen se va degradando porque esta compresión con pérdidas codding porque cuando eras un rehén con el tamaño se reduce es porque en especial con vídeos grabados de celular o de una cámara cuando necesariamente va grabando todos los frames igual puede lo más puede ser frente tipo p pero no puede codificar con frames tipo b cuando está grabando algún vivo que no conoce el fútbol entonces nos guarda el vídeo y al mismo vídeo tal cual uno le hace un rincón y él como ahora tiene el futuro va a poder usar muchos frentes tipo b y eso hace que ganase un rencor y la compresión aumenta muchísimo además de hacer un récord de 12 a la librería x 12 41 puedes usar otras librerías por ejemplo quiero que este clip x 25 de lujo y ahora estamos como ahora está usando la librería en x 265 esta librería es lo que genera vídeos de la misma calidad del x 12 4 pero en mucho mayor compresión lo que hay en el blog el soporte del x 265 no es tan amplio como el del equipo de 4 mil 265 de que está disponible en hace unos 4 años atrás y por tanto dos celulares muy antiguos no pueden producir y veamos cómo queda un tamaño aquí dice lo mismo los la cantidad flex y héiber y 1 2 3 4 y 5 también se puede con flujo a través de un vídeo de casi nada y si lo reproducimos [Música] está el bien no quieren y que esté el día que estábamos dando la mitad que es la teoría [Música] en él [Música] por los comandos útiles es el de la otra cosa es que uno puede bajarle la calidad si uno quiere reducir mucho el tamaño de una imagen de un vídeo uno puede bajar la querían hombre decirse efe crf es la calidad de el resultado final con 25 es una calidad muy buena y mientras más grande es peor solo le pone un nombre como 40 por ejemplo va a ser un vídeo de muy mala calidad los flujos 4 [Música] pero que va a comprimir se va a comprimir mucho entonces a veces 11 cuando necesita con vida sea de muy poco tamaño uno empieza a jugar con el scf oa jugar con la escala llegará un poco el tamaño aumenta lo frente y por d como el estudio el precio veis lo que se refiere a que él gaste más tiempo el algoritmo para encontrar los mejores vectores de muy bien como esto lo mental de movimiento en principio pueden buscar en todos los frentes hicieran eso en todo el frente todas las posibles combinaciones esos demasiados y sería todo muy lento se hacen ciertas juris ticas para encontrar rápido por el mejor factor de movimiento si uno le dice que se puede tomar más tiempo el algo impulsado a tomar más tiempo para encontrar mejores cartes de los muchos besos y por tanto la calidad va a mejorar sin ocupar más espacio él el cuadro como no puede reducir a menos y si lo reproducimos esta actividad 14 la calidad claro un poco un tercio del vídeo original pero podéis buscando un balance de entonces venga quien sepa cómo pueden ajustar el tamaño de los vídeos algo que es muy bueno también para hacer de la ciencia en esto no puede cortar vídeos sin tener que hacer los recogen está el code com gobierno y por tanto es algo muy rápido 1 extraer una sección de un vídeo por ejemplo y el de éste le quiero sacar un trozo de a partir del segundo 40 un trozo de 10 y 11 millones sacar con el códec de vídeo y no será nada y genera en el archivo o copia aquí al reproducirlo al reproducirlo es exactamente esos segundos quien piensa que solamente y no tuvo que ser eso lo tiene que saber ese truco el truco final es que uno va a tener un comando nacional facebook no puede extraer todos los frentes un vídeo esencialmente decodificar vídeo en general miles de imágenes y porque es útil porque a veces uno puede empezar a quitar las imágenes y luego que uno puede contar todas esas imágenes y volver a crear un vida aquí una vez se toma todas las imágenes con este patrón y quiere un vídeo con un frame rate de tres generales bueno y aquí uno voy a ponerle el tipo de coaching de vídeos para terminar aquí les dejo planteado un ejercicio bueno